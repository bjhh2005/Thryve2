# Thryve - 智能文件处理可视化工作流编辑器

[English](README.md) | 简体中文

[![Version](https://img.shields.io/badge/version-1.0-blue.svg)](https://github.com/your-username/Thryve2)
[![PRs Welcome](https://img.shields.io/badge/PRs-welcome-brightgreen.svg)]()
[![Contributors](https://img.shields.io/badge/contributors-5-orange.svg)]()
[![Made with React](https://img.shields.io/badge/React-18-%2361DAFB.svg?logo=react)](https://reactjs.org/)

Thryve 是一个专注于智能文件处理的可视化工作流编辑器。通过直观的节点式编程界面，用户可以轻松创建复杂的文件处理工作流，如批量文件操作、格式转换、内容分析和自动化文档处理。项目采用前后端分离架构，提供强大的工作流执行引擎和实时处理反馈。

## 功能特点

### 📂 **智能文件处理系统**
- **批量处理操作**：同时处理数百个文件，具备进度跟踪和错误处理能力
- **通用格式支持**：原生支持 PDF、DOC/DOCX、Markdown、CSV、JSON、TXT 和图像格式
- **智能内容提取**：自动文本提取、元数据解析和内容结构分析
- **文档智能识别**：OCR 光学字符识别、表格识别和自动文档分类
- **格式转换**：不同文件格式间的无缝转换，保持结构完整性
- **内容分析**：文本分析、关键词提取、情感分析和内容摘要生成

### 🎨 **可视化工作流设计器**
- **拖拽式界面**：直观的节点式编辑器，支持网格对齐和自动排列
- **智能连接系统**：智能端口检测和节点间类型安全的连接
- **画布导航**：缩放、平移和缩略图，支持大型工作流可视化
- **视觉反馈**：实时节点状态指示器、进度条和执行高亮显示
- **自定义布局**：灵活的节点定位，提供自动布局建议
- **导出功能**：将工作流导出为图像或可打印的图表

### 🔌 **全面的节点库**
- **控制流节点**：开始、结束、条件（多输出分支）、循环（for/while 迭代）
- **数据处理节点**：变量赋值、数据转换、过滤和排序操作
- **文件操作节点**：文件输入/输出、文件夹扫描、文件复制和批量处理
- **文本处理节点**：字符串操作、正则表达式、文本格式化和编码转换
- **逻辑节点**：数学运算、布尔逻辑、比较操作和条件语句
- **集成节点**：API 调用、数据库连接、邮件发送和 Webhook 触发器

### 📝 **实时执行引擎**
- **实时状态更新**：实时节点执行状态，彩色编码指示器（处理中、成功、错误）
- **进度跟踪**：长时间运行操作的详细进度条和时间估算
- **输出监控**：实时输出流，支持不同数据类型的语法高亮
- **错误报告**：全面的错误消息，包含堆栈跟踪和解决方案建议
- **性能指标**：执行时间跟踪、内存使用监控和吞吐量统计
- **执行历史**：完整的工作流运行日志，支持历史记录搜索

### 🔄 **高级控制流**
- **条件分支**：基于动态条件的多输出路径，支持自定义表达式
- **循环控制**：支持嵌套循环、break/continue 语句和迭代变量
- **并行执行**：并发节点执行，支持同步点和竞态条件处理
- **错误处理**：try-catch 块、重试机制和优雅的错误恢复
- **流程控制**：跳转到特定节点、跳过操作和动态工作流路由
- **状态管理**：跨工作流执行的持久状态，支持变量作用域

### 💾 **工作流管理**
- **项目组织**：层次化项目结构，支持文件夹、标签和搜索功能
- **版本控制**：内置版本系统，支持差异可视化和回滚功能
- **导入/导出**：基于 JSON 的工作流格式，支持向后兼容和迁移工具
- **模板系统**：预构建的工作流模板，适用于常见用例和行业标准
- **共享与协作**：导出工作流以与团队成员和社区共享
- **备份与恢复**：自动备份，支持云同步和灾难恢复选项

### 🖥️ **跨平台桌面应用**
- **原生性能**：基于 Electron 的桌面应用，具备原生操作系统集成
- **多显示器支持**：在多个屏幕间拖拽工作流，独立缩放级别
- **键盘快捷键**：为高级用户和无障碍访问提供全面的热键系统
- **系统集成**：文件关联、系统托盘操作和操作系统通知支持
- **离线功能**：无需互联网连接即可完整运行，适合敏感工作流
- **性能优化**：硬件加速和大型工作流的内存管理

### 🌐 **实时通信**
- **WebSocket 集成**：前后端双向实时通信
- **实时协作**：多用户可同时查看工作流执行过程
- **远程监控**：从多个设备和位置监控工作流执行
- **事件广播**：工作流事件和系统状态的实时通知
- **安全通信**：加密的 WebSocket 连接，支持身份验证和授权
- **连接管理**：网络问题时的自动重连和优雅降级

### 🔍 **集成测试与验证**
- **测试模式**：干运行执行，不对文件或系统进行实际更改
- **输入验证**：执行前验证节点配置和数据类型
- **单元测试**：使用模拟数据和预期输出验证的单个节点测试
- **集成测试**：使用真实数据和外部依赖的端到端工作流测试
- **性能测试**：大数据集的负载测试和性能基准测试
- **回归测试**：针对先前版本自动测试工作流更改

### 🚀 **高级工作流功能**
- **函数调用**：模块化子工作流执行，支持参数传递和返回值处理
- **内存管理**：智能内存优化，支持自动清理和内存泄漏检测
- **断点调试**：高级调试功能，支持条件断点、单步执行和变量检查
- **AI智能体集成**：基于大语言模型的智能工作流自动化和自然语言处理

## 技术亮点

### 事件总线架构 (Event Bus Architecture)

后端采用事件总线架构设计，具有以下优势：

- 🔄 **松耦合设计**: 通过事件总线实现节点间的解耦，每个节点都是独立的组件
- 📢 **事件驱动**: 采用发布-订阅模式，支持节点间的异步通信
- 🏭 **工厂模式**: 使用节点工厂统一管理节点的创建和生命周期
- 🔌 **可扩展性**: 轻松添加新节点类型，无需修改现有代码
- 🎯 **精确控制**: 支持条件节点多输出端口、循环节点流程控制等复杂场景
- 🔍 **状态追踪**: 通过事件总线实现工作流执行状态的实时监控

```python
# 事件总线示例
class WorkflowEngine:
    def __init__(self):
        self.bus = EventBus()
        self.bus.on("askMessage", self.askMessage)
        self.bus.on("putStack", self.putStack)
        # ... 更多事件监听
```

### 智能变量同步系统 (Smart Variable Sync System)

前端实现了一套智能的变量同步系统，具有以下特点：

- 🔄 **实时同步**: 通过插件机制实现节点输出的实时变量同步
- 🔍 **类型安全**: 基于 JSON Schema 的类型系统，确保变量类型的正确性
- 🎯 **智能命名**: 自动根据节点标题生成易读的变量名称
- 🖼️ **可视化增强**: 为变量添加图标和元数据，提升用户体验
- 🛡️ **数据验证**: 内置数据合法性检查，防止无效数据传递
- 📦 **特殊类型处理**: 针对文件输入等特殊节点类型的定制化处理

```typescript
// 变量同步示例
export const createSyncVariablePlugin = definePluginCreator({
  onInit(ctx) {
    ctx.document.onNodeCreate(({ node }) => {
      // 监听节点创建和更新事件
      const variableData = node.getData(FlowNodeVariableData);
      
      // 自动同步节点输出到变量系统
      variableData.setVar(
        ASTFactory.createVariableDeclaration({
          meta: { title, icon },
          key: nodeId,
          type: typeAST
        })
      );
    });
  }
});
```

这种设计不仅简化了用户的使用体验，还通过类型系统和数据验证确保了工作流的可靠性。变量同步系统作为前后端之间的桥梁，大大提升了数据流的可维护性和稳定性。

### 实时日志反馈系统 (Real-time Logging System)

基于 Socket.IO 实现的实时日志反馈系统，具有以下特点：

- 🔄 **实时反馈**: 通过 WebSocket 实现工作流执行状态的实时推送
- 🎨 **分级展示**: 支持多种日志级别（INFO、WARN、ERROR、SUCCESS、SYSTEM、OUTPUT）
- 🎯 **节点定位**: 每条日志都可以追踪到具体的节点
- 💫 **动态更新**: 自动滚动和实时更新的日志界面
- 🎭 **样式美化**: 每种日志类型都有独特的视觉样式
- 🛡️ **错误处理**: 完整的错误捕获和展示机制

```typescript
// 前端日志处理示例
socket.on('info', (data) => addLog({ 
    level: 'INFO', 
    message: data.message, 
    nodeId: data.nodeId 
}));

// 后端日志发送示例
engine.bus.on('workflow', lambda nodeId: 
    socketio.emit('workflow', {
        "nodeId": nodeId
    }, namespace='/workflow')
)
```

这种设计让用户能够实时监控工作流的执行过程，快速定位问题，提供了优秀的调试体验。系统不仅能显示执行状态，还能展示每个节点的输出结果，大大提升了工作流开发和调试的效率。

### 函数调用系统 (Function Call System)

基于模块化设计的高级子工作流执行系统：

- 🔄 **模块化子工作流**:
  - 调用节点：以函数方式执行子工作流，支持参数传递
  - 返回值处理和数据流管理
  - 基于栈的执行上下文管理

- 🔗 **工作流组合**:
  - 层次化工作流结构
  - 可复用的工作流组件
  - 运行时参数的动态工作流调用

- 📊 **执行管理**:
  - 多工作流执行引擎
  - 并发工作流处理
  - 高级调用栈管理和调试

### 内存管理系统 (Memory Management System)

面向大规模工作流的智能内存优化：

- 🧠 **自动内存清理**:
  - 子工作流内存隔离和清理
  - 节点实例生命周期管理
  - 已完成工作流的垃圾回收

- 📈 **内存监控**:
  - 实时内存使用跟踪
  - 每个工作流的内存消耗分析
  - 内存泄漏检测和预防

- ⚡ **性能优化**:
  - 延迟节点实例化
  - 内存高效数据结构
  - 自动资源释放

### 高级调试系统 (Advanced Debugging System)

面向复杂工作流的专业调试能力：

- 🔍 **断点系统**:
  - 自定义表达式的条件断点
  - 节点特定的断点管理
  - 逐步执行控制

- 🎯 **调试控制**:
  - 暂停/恢复执行
  - 单步执行功能
  - 实时变量检查

- 📊 **执行分析**:
  - 节点执行时间分析
  - 数据流可视化
  - 错误跟踪和堆栈分析

### AI 增强工作流系统 (AI-Enhanced Workflow System)

集成了先进的 AI 能力，为工作流提供智能化支持：

- 🤖 **双模式 AI 助手**:
  - Agent 自动操作模式：AI 自动执行工作流任务
  - Ask 交互式对话模式：通过自然语言与 AI 助手交互

- 🧠 **智能节点类型**:
  - LLM 节点：集成 OpenAI API 的大语言模型能力
  - 文档分析节点：自动化文档理解与处理
  - 文本处理节点：基于 AI 的高级文本处理能力

- 📊 **文档智能处理**:
  - 自动文档分析与结构化
  - 从 PDF、Word 文档等智能信息提取
  - 文本摘要与重点提取

- 🔄 **智能工作流优化**:
  - 自动流程优化建议
  - 智能错误诊断和恢复
  - 性能瓶颈检测和报告

### 智能节点推荐系统 (Node Recommendation System) 🚧

> 🔥 创新特性规划

基于用户行为和工作流模式的智能推荐系统：

- 🎯 **上下文感知推荐**:
  - 基于当前节点类型推荐下一个最可能需要的节点
  - 智能识别常用节点组合模式
  - 自动补全节点配置建议

- 📊 **使用模式分析**:
  - 收集匿名的工作流使用数据
  - 分析最佳实践和常用模式
  - 为用户提供优化建议

### 协同编辑系统 (Collaborative Editing) 🚧

支持多人实时协作编辑工作流：

- 👥 **实时协作**:
  - 多用户同时编辑支持
  - 实时变更同步
  - 编辑冲突解决

- 📝 **版本控制**:
  - 工作流版本历史记录
  - 变更对比和回滚
  - 分支管理与合并

### 工作流模板市场 (Workflow Template Marketplace) 🚧

社区驱动的工作流模板生态系统：

- 🏪 **模板市场**:
  - 预置行业标准工作流模板
  - 用户自定义模板分享
  - 模板评分和评论系统

- 🔄 **一键复用**:
  - 模板快速导入
  - 参数自动适配
  - 模板组合与定制



### 自适应布局系统 (Adaptive Layout System) 🚧

智能的界面布局优化：

- 📱 **响应式设计**:
  - 自适应屏幕大小
  - 智能节点排列
  - 自动避免节点重叠

- 🎨 **智能美化**:
  - 自动对齐和分布
  - 智能连线路径规划
  - 节点组自动布局

这些技术特性构成了 Thryve 的核心竞争力，为用户提供了专业级的工作流开发体验。通过模块化设计、智能调试、内存优化和 AI 集成，Thryve 不仅简化了复杂工作流的开发，更提升了执行效率和可维护性。

## 技术架构

### 前端 (Fronted1)

- **框架**: React 18 + TypeScript
- **构建工具**: Vite
- **桌面支持**: Electron
- **主要依赖**:
  - @flowgram.ai 系列组件（布局编辑器、插件等）
  - Socket.IO 客户端
  - React 相关生态

### 后端 (Backend)

- **框架**: Python
- **主要模块**:
  - 工作流执行引擎 (Engine.py) 支持调试功能
  - 多工作流管理器 (WorkflowManager.py) 支持函数调用系统
  - 事件总线系统 (EventBus.py) 实现松耦合架构
  - 节点工厂模式实现 (Factory.py)
  - WebSocket 服务器支持实时通信
  - 内存管理系统支持自动清理
  - 高级调试引擎支持断点功能

## 项目结构

```
Thryve2/
├── Backend/                # 后端服务
│   ├── app.py             # 主应用服务器
│   └── workflows/         # 工作流相关模块
│       ├── Engine.py      # 工作流执行引擎（支持调试）
│       ├── WorkflowManager.py # 多工作流管理器
│       ├── Factory.py     # 节点工厂
│       ├── events/        # 事件处理
│       │   └── EventBus.py # 事件总线实现
│       └── nodes/         # 节点类型定义
│           ├── CallNode.py     # 函数调用节点
│           ├── LLM.py          # AI LLM 集成
│           ├── TextProcessor.py # 文本处理
│           ├── PdfProcessor.py # PDF 处理
│           └── [+20 个其他节点]
│
├── Fronted1/              # 前端应用
│   ├── src/              # 源代码
│   │   ├── components/   # UI组件
│   │   │   ├── BreakpointToggle/ # 调试控制
│   │   │   ├── sidebar-left/    # AI 助手面板
│   │   │   └── testrun/         # 测试执行
│   │   ├── context/      # React Context
│   │   │   ├── BreakpointProvider.tsx # 调试上下文
│   │   │   └── ChatProvider.tsx      # AI 聊天上下文
│   │   ├── nodes/        # 节点实现
│   │   ├── plugins/      # 插件系统
│   │   │   ├── runtime-plugin/    # 运行时集成
│   │   │   └── sync-variable-plugin/ # 变量同步
│   │   └── services/     # 服务层
│   └── electron/         # Electron 相关
```

## 快速开始

### 环境要求

- Node.js >= 14
- Python >= 3.8
- npm 或 yarn

### 安装步骤

1. 克隆仓库
```bash
git clone https://github.com/bjhh2005/Thryve2.git
cd Thryve2
```

2. 安装前端依赖
```bash
cd Fronted1
npm install
```

3. 安装后端依赖
```bash
cd ../Backend
pip install -r requirements.txt
```

### 启动开发环境

1. 启动后端服务
```bash
cd Backend
python app.py
```

2. 启动前端开发服务器
```bash
cd Fronted1
npm run dev          # 网页版
# 或
npm run electron:dev # 桌面应用版
```

### 构建生产版本

```bash
cd Fronted1
npm run electron:build
```

生成的安装包将位于 `Fronted1/release` 目录。

## 核心功能示例

### 使用函数调用

通过调用节点创建模块化工作流，执行子工作流：

```javascript
// 主工作流调用文件处理子工作流
{
  "type": "call",
  "subworkflow_id": "file_processor",
  "input_parameters": {
    "file_path": "documents/input.pdf",
    "output_format": "markdown"
  }
}
```

### 设置调试功能

启用断点和逐步调试：

1. 点击任意节点的断点切换按钮
2. 使用调试面板控制执行
3. 实时监控变量值
4. 逐个节点单步执行工作流

### AI 集成

在工作流中利用 AI 能力：

```javascript
// LLM 节点进行文本处理
{
  "type": "llm",
  "model": "gpt-3.5-turbo",
  "prompt": "请总结以下文档内容: {input_text}",
  "max_tokens": 150
}
```

### 内存管理

监控和优化工作流内存使用：

- 在控制台面板查看内存使用情况
- 已完成子工作流的自动清理
- 内存泄漏检测和警告